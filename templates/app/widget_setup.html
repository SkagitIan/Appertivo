{% extends 'base/base.html' %}

{% block title %}Widget Setup - Appertivo{% endblock %}

{% block content %}
<div class="min-h-screen bg-slate-50">
    <!-- Navigation -->
    <nav class="bg-white border-b border-slate-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0 flex items-center">
                        <div class="w-8 h-8 gradient-primary rounded-lg flex items-center justify-center">
                            <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4"></path>
                            </svg>
                        </div>
                        <span class="ml-3 text-xl font-semibold text-slate-900">Appertivo</span>
                    </div>
                    
                    <div class="hidden md:flex ml-10 space-x-8">
                        <a href="{% url 'dashboard' %}" class="text-slate-600 hover:text-slate-900 font-medium py-4">Dashboard</a>
                        <a href="{% url 'specials_list' %}" class="text-slate-600 hover:text-slate-900 font-medium py-4">Specials</a>
                        <a href="{% url 'connections' %}" class="text-slate-600 hover:text-slate-900 font-medium py-4">Connections</a>
                        <a href="{% url 'widget_setup' %}" class="text-slate-900 border-b-2 border-blue-500 font-medium py-4">Widget</a>
                    </div>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div class="text-sm text-slate-600">
                        Welcome, {{ user.profile.restaurant_name|default:user.username }}
                    </div>
                    <a href="{% url 'logout' %}" class="text-slate-600 hover:text-slate-900 font-medium">Sign out</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-4xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
        <div class="mb-8">
            <div class="flex items-center">
                <a href="{% url 'dashboard' %}" class="text-slate-500 hover:text-slate-700">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                    </svg>
                </a>
                <nav class="ml-4">
                    <ol class="flex items-center space-x-2 text-sm">
                        <li><a href="{% url 'dashboard' %}" class="text-slate-500 hover:text-slate-700">Dashboard</a></li>
                        <li class="text-slate-400">/</li>
                        <li class="text-slate-900 font-medium">Widget Setup</li>
                    </ol>
                </nav>
            </div>
            
            <div class="mt-4">
                <h1 class="text-2xl font-bold text-slate-900">Embed Widget</h1>
                <p class="mt-2 text-slate-600">Add the Appertivo widget to your restaurant website to showcase daily specials and capture customer emails.</p>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Widget Code -->
            <div class="bg-white stripe-shadow rounded-lg p-6">
                <h2 class="text-lg font-semibold text-slate-900 mb-4">Embed Code</h2>
                <p class="text-sm text-slate-600 mb-4">
                    Copy this code and paste it into your website where you want the special widget to appear:
                </p>
                
                <div class="bg-slate-50 border border-slate-200 rounded-lg p-4 mb-4">
                    <code class="text-sm font-mono text-slate-800" id="embed-code">
&lt;div id="appertivo-widget"&gt;&lt;/div&gt;
&lt;script src="{% url 'widget_js' user.id %}"&gt;&lt;/script&gt;
                    </code>
                </div>
                
                <button onclick="copyEmbedCode()" class="btn-primary text-sm" data-testid="button-copy-code">
                    ðŸ“‹ Copy Code
                </button>
                
                <div class="mt-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                    <h3 class="text-sm font-medium text-blue-900 mb-2">Features:</h3>
                    <ul class="text-sm text-blue-800 space-y-1">
                        <li>â€¢ Shows today's active special automatically</li>
                        <li>â€¢ Includes email signup for viral growth</li>
                        <li>â€¢ Responsive design works on all devices</li>
                        <li>â€¢ Click tracking for analytics</li>
                        <li>â€¢ Direct order links or phone calls</li>
                    </ul>
                </div>
            </div>

            <!-- Widget Preview -->
            <div class="bg-white stripe-shadow rounded-lg p-6">
                <h2 class="text-lg font-semibold text-slate-900 mb-4">Live Preview</h2>
                <p class="text-sm text-slate-600 mb-4">
                    This is how your widget will look on your website:
                </p>
                
                <!-- Widget Preview Container -->
                <div id="appertivo-widget-preview" class="border border-slate-200 rounded-lg p-4 bg-slate-50">
                    <div class="text-center text-slate-500 py-8">
                        Loading preview...
                    </div>
                </div>
                
                <div class="mt-4 p-4 bg-amber-50 border border-amber-200 rounded-lg">
                    <h3 class="text-sm font-medium text-amber-900 mb-2">Pro Tips:</h3>
                    <ul class="text-sm text-amber-800 space-y-1">
                        <li>â€¢ Place widget on your homepage for maximum visibility</li>
                        <li>â€¢ Update specials regularly to keep content fresh</li>
                        <li>â€¢ Email subscribers automatically when new specials are published</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Demo Widget Section -->
        <div class="mt-8 bg-white stripe-shadow rounded-lg p-6">
            <h2 class="text-lg font-semibold text-slate-900 mb-4">Test Your Widget</h2>
            <p class="text-sm text-slate-600 mb-4">
                Create a special first, then test how your widget works:
            </p>
            
            <div class="flex space-x-4">
                <a href="{% url 'create_special' %}" class="btn-primary" data-testid="button-create-special">
                    Create Your First Special
                </a>
                <button onclick="refreshPreview()" class="btn-outline" data-testid="button-refresh-preview">
                    Refresh Preview
                </button>
            </div>
        </div>
    </main>
</div>

<script>
function copyEmbedCode() {
    const code = document.getElementById('embed-code').textContent;
    navigator.clipboard.writeText(code).then(() => {
        const btn = event.target;
        const originalText = btn.textContent;
        btn.textContent = 'âœ“ Copied!';
        btn.classList.add('bg-green-600');
        setTimeout(() => {
            btn.textContent = originalText;
            btn.classList.remove('bg-green-600');
        }, 2000);
    });
}

function loadWidgetPreview() {
    // Load the actual widget in preview
    fetch('{% url "widget_special" user.id %}')
        .then(response => response.json())
        .then(data => {
            const preview = document.getElementById('appertivo-widget-preview');
            if (data.special) {
                const special = data.special;
                preview.innerHTML = `
                    <div style="max-width: 400px; background: white; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); overflow: hidden; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 16px; text-align: center;">
                            <h3 style="margin: 0;">Today's Special at ${special.restaurant_name}</h3>
                        </div>
                        <div style="padding: 20px; text-align: center;">
                            ${special.image ? `<img src="${special.image}" alt="${special.title}" style="width: 100%; height: 200px; object-fit: cover; border-radius: 8px; margin-bottom: 12px;">` : ''}
                            <div style="font-size: 20px; font-weight: bold; margin-bottom: 8px; color: #1f2937;">${special.title}</div>
                            <div style="color: #6b7280; margin-bottom: 12px; line-height: 1.5;">${special.description}</div>
                            <div style="font-size: 24px; font-weight: bold; color: #059669; margin-bottom: 16px;">$${special.price}</div>
                            ${special.cta_type === 'web' && special.cta_url ? 
                                `<a href="${special.cta_url}" style="display: inline-block; background: #3b82f6; color: white; padding: 12px 24px; border-radius: 8px; text-decoration: none; font-weight: 500; margin-bottom: 16px;">Order Online</a>` :
                                special.cta_type === 'call' && special.cta_phone ? 
                                `<a href="tel:${special.cta_phone}" style="display: inline-block; background: #3b82f6; color: white; padding: 12px 24px; border-radius: 8px; text-decoration: none; font-weight: 500; margin-bottom: 16px;">Call to Order</a>` : ''
                            }
                            <div style="border-top: 1px solid #e5e7eb; padding-top: 16px; margin-top: 16px;">
                                <p style="margin-bottom: 8px; font-size: 14px; color: #6b7280;">Get notified about future specials:</p>
                                <div style="display: flex; gap: 8px;">
                                    <input type="email" placeholder="Enter your email" style="flex: 1; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                                    <button style="background: #059669; color: white; border: none; padding: 10px 16px; border-radius: 6px; cursor: pointer; font-weight: 500;">Subscribe</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                preview.innerHTML = `
                    <div style="max-width: 400px; background: white; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); overflow: hidden; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 16px; text-align: center;">
                            <h3 style="margin: 0;">{{ user.profile.restaurant_name|default:user.username }}</h3>
                        </div>
                        <div style="text-align: center; padding: 40px 20px; color: #6b7280;">
                            <p>No special available today.</p>
                            <p>Check back soon!</p>
                        </div>
                    </div>
                `;
            }
        })
        .catch(err => {
            console.error('Preview error:', err);
            document.getElementById('appertivo-widget-preview').innerHTML = '<p style="text-align: center; color: #ef4444;">Unable to load preview</p>';
        });
}

function refreshPreview() {
    document.getElementById('appertivo-widget-preview').innerHTML = '<div class="text-center text-slate-500 py-8">Loading preview...</div>';
    loadWidgetPreview();
}

// Load preview on page load
document.addEventListener('DOMContentLoaded', loadWidgetPreview);
</script>
{% endblock %}