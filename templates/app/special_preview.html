{% extends 'app/base.html' %}
{% block title %}Preview Special Â· Appertivo{% endblock %}
{% block content %}
{% if request.user.is_anonymous %}
<div class="container py-5">
  <div class="row justify-content-center">
    <div class="col-md-6 text-center">
      <h2 class="mb-3">Create an account to preview your special</h2>
      <a class="btn btn-primary" href="{% url 'signup' %}">Sign up</a>
    </div>
  </div>
</div>
{% else %}
<div class="container py-5">
  <div class="row g-4 align-items-top">
    <!-- LEFT: Widget-style preview (sticky) -->
    <div class="col-lg-5">
      <div class="position-sticky" style="top: 88px;">
        <div class="card widget-frame border-ink-800 shadow-sm">
          <div class="card-body">
              <div id="special-preview-container"
               hx-target="#special-preview-container"
               hx-swap="innerHTML" style="position: relative;">

            <div class="p-2 text-center text-secondary">
                <div id="appertivo-preview"></div>

                <script>
                  // Configure BEFORE loading the widget script
                  window.appertivoConfig = {
                    mount: '#appertivo-preview',   // where to render inline
                    inline: true,                  // render inside the div, not floating
                    openOnLoad: true,              // show as if clicked
                    // optional: inlineWidth: '100%', inlineMaxWidth: '520px'
                  };
                </script>
                <script src="http://127.0.0.1:8000/appertivo-widget.js?restaurant=13&special={{ special.pk }}"></script>
            </div>
          </div>
          </div>
        </div>
      </div>
    </div>

    <!-- RIGHT: Edit form (embedded) -->
    <div class="col-lg-7">

      {# Render the same form partial but in "embedded" mode #}
      <div class="special-form-embedded bg-light p-5 rounded">
        {% include 'app/partials/special_form.html' with form=form action_url=publish_url submit_label='Publish' %}
      </div>
    </div>
  </div>
</div>

<script>
// After the form partial renders, rewire its Refresh button to hit this page's widget fragment.
document.addEventListener('DOMContentLoaded', () => {
  window.scrollTo(0,0);
  const btn = document.getElementById('btn-refresh-preview');
  if (btn) {
    btn.setAttribute('hx-get', "{% url 'special_preview' special.pk %}?fragment=widget");
    btn.setAttribute('hx-target', '#special-preview-container');
    btn.setAttribute('hx-swap', 'innerHTML');
  }
});
</script>
{% endif %}
{% endblock %}
