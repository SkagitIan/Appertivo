{% load form_tags %}
<!-- ===================================== -->
<!-- /templates/partials/special_form.html -->
<!-- Minimal structure; keep your existing -->
<!-- form fields and server-side validation -->
<!-- ===================================== -->
{% load form_tags %}
<form method="POST" enctype="multipart/form-data"
      hx-post="{% url 'special_create' %}"
      hx-target="#special-form-container"
      hx-swap="innerHTML"
      id="special-form">
  {% csrf_token %}
  {{ form.non_field_errors }}

  <div class="row g-3 p-4">
    <div class="col-12">
      <label class="form-label">Title</label>
      {{ form.title|add_class:"form-control form-control-lg" }}
    </div>
    <div class="col-12">
      <label class="form-label">Description</label>
      {{ form.description|add_class:"form-control" }}
      <div class="form-text"><span id="desc-count">0</span>/160</div>
    </div>
    <div class="col-md-6">
      <label class="form-label">Start Date</label>
      {{ form.start_date|add_class:"form-control" }}
    </div>
    <div class="col-md-6">
      <label class="form-label">End Date</label>
      {{ form.end_date|add_class:"form-control" }}
    </div>
    <div class="col-md-6">
      <label class="form-label">Price</label>
      {{ form.price|add_class:"form-control" }}
    </div>
    <div class="col-md-6">
      <label class="form-label">Image</label>
      {{ form.image|add_class:"form-control" }}
    </div>

    <!-- CTA choices / URLs (adapt to your fields) -->
    <div class="col-12">
      <label class="form-label">Call-to-Action</label>
      {{ form.cta_choices }}
    </div>
    <div class="col-md-4">{{ form.order_url|add_class:"form-control" }}</div>
    <div class="col-md-4">{{ form.mobile_order_url|add_class:"form-control" }}</div>
    <div class="col-md-4">{{ form.phone_number|add_class:"form-control" }}</div>

    <div class="col-12 d-flex gap-2">
      <button type="submit" class="btn btn-orange">Save Draft</button>
      <button type="button" class="btn btn-outline-light" hx-get="" hx-target="#special-preview-container" hx-swap="innerHTML">Refresh Preview</button>
    </div>
  </div>
</form>


<script>
function updateCounter(inputElem, counterElem, maxLen) {
  const currentLength = inputElem.value.length;
  counterElem.textContent = `${currentLength} / ${maxLen}`;
  
  // Add visual feedback for character count
  if (currentLength > maxLen * 0.9) {
    counterElem.classList.add('text-warning');
  } else if (currentLength === maxLen) {
    counterElem.classList.remove('text-warning');
    counterElem.classList.add('text-danger');
  } else {
    counterElem.classList.remove('text-warning', 'text-danger');
  }
}

function setupCounters(container) {
  const titleInput = container.querySelector('input[name="title"]');
  const titleCounter = container.querySelector('#title-counter');
  if (titleInput && titleCounter) {
    updateCounter(titleInput, titleCounter, 60);
    titleInput.addEventListener('input', () => updateCounter(titleInput, titleCounter, 60));
  }

  const descInput = container.querySelector('textarea[name="description"]');
  const descCounter = container.querySelector('#description-counter');
  if (descInput && descCounter) {
    updateCounter(descInput, descCounter, 250);
    descInput.addEventListener('input', () => updateCounter(descInput, descCounter, 250));
  }
}

function toggleCTAFields() {
  const selectedCTA = document.querySelector('input[name="cta_choices"]:checked')?.value;

  const groups = {
    order: document.getElementById('order-url-group'),
    call: document.getElementById('phone-number-group'),
    mobile_order: document.getElementById('mobile-order-url-group')
  };

  for (const key in groups) {
    if (groups[key]) {
      if (selectedCTA === key) {
        groups[key].classList.remove('d-none');
        // Add smooth animation
        groups[key].style.opacity = '0';
        setTimeout(() => {
          groups[key].style.transition = 'opacity 0.3s ease';
          groups[key].style.opacity = '1';
        }, 10);
      } else {
        groups[key].classList.add('d-none');
        groups[key].style.opacity = '0';
        const input = groups[key].querySelector('input');
        if (input) input.value = '';
      }
    }
  }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
  setupCounters(document);
  toggleCTAFields();
  document.querySelectorAll('input[name="cta_choices"]').forEach(radio => {
    radio.addEventListener('change', toggleCTAFields);
  });
});

// HTMX event handler
document.addEventListener('htmx:afterSwap', (event) => {
  if (event.detail.target.id === 'special-form-container') {
    setupCounters(event.detail.target);
    toggleCTAFields();
    event.detail.target.querySelectorAll('input[name="cta_choices"]').forEach(radio => {
      radio.addEventListener('change', toggleCTAFields);
    });
  }
});
</script>