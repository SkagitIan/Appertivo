(() => {
  // -------------------------------
  // Config & helpers
  // -------------------------------
  const scriptEl =
    document.currentScript ||
    document.getElementById('appertivo-widget') ||
    document.querySelector('script[src*="appertivo-widget"]');

  // Read booleans safely from data-attrs
  const readBool = (v, fallback=false) => {
    if (typeof v === 'boolean') return v;
    if (typeof v === 'string') return ['true', '1', 'yes'].includes(v.toLowerCase());
    return fallback;
  };

  // Defaults + external overrides (window.appertivoConfig and data-attrs)
  const cfg = Object.assign(
    {
      // Behavior
      mount: null,                 // e.g. '#appertivo-preview'
      inline: false,
      openOnLoad: false,
      inlineWidth: '100%',
      inlineMaxWidth: '520px',

      // Launcher customization (future-proof)
      launcherIcon: 'ðŸ½ï¸',         // emoji or short text
      launcherLabel: "View Today's Special",
      launcherBg: 'linear-gradient(135deg,#B993D6,#f08000)',
      launcherColor: '#ffffff',
      launcherShape: 'circle',     // 'circle' | 'pill'
      launcherSize: 70             // number(px) or string ('70px')
    },
    window.appertivoConfig || {}
  );

  // Data-attrs (win over defaults but under window.appertivoConfig)
  const data = scriptEl ? scriptEl.dataset : {};
  if (data) {
    if (data.mount) cfg.mount = data.mount;
    if (typeof data.inline !== 'undefined') cfg.inline = readBool(data.inline, cfg.inline);
    if (typeof data.openOnLoad !== 'undefined') cfg.openOnLoad = readBool(data.openOnLoad, cfg.openOnLoad);
    if (data.inlineWidth) cfg.inlineWidth = data.inlineWidth;
    if (data.inlineMaxWidth) cfg.inlineMaxWidth = data.inlineMaxWidth;

    if (data.launcherIcon) cfg.launcherIcon = data.launcherIcon;
    if (data.launcherLabel) cfg.launcherLabel = data.launcherLabel;
    if (data.launcherBg) cfg.launcherBg = data.launcherBg;
    if (data.launcherColor) cfg.launcherColor = data.launcherColor;
    if (data.launcherShape) cfg.launcherShape = data.launcherShape;
    if (data.launcherSize) {
      const sz = /^\d+$/.test(data.launcherSize) ? Number(data.launcherSize) : data.launcherSize;
      cfg.launcherSize = sz;
    }
  }

  const restaurantId = (scriptEl?.dataset.restaurantId) || "{{ restaurant_id|escapejs }}";
  const apiUrl       = (scriptEl?.dataset.apiUrl)       || "{{ api_url|escapejs }}";
  const subscribeUrl = (scriptEl?.dataset.subscribeUrl) || "{{ subscribe_url|escapejs }}";
  const specialId = (scriptEl?.dataset.specialId) || "{{ special_id|escapejs }}";


  if (!restaurantId) {
    console.warn('Appertivo Widget: No restaurant ID specified.');
    return;
  }

  // -------------------------------
  // Host + Shadow root
  // -------------------------------
  let host;
  if (cfg.inline && cfg.mount) {
    host = document.querySelector(cfg.mount);
    if (!host) {
      console.warn('Appertivo Widget: mount selector not found:', cfg.mount);
      return;
    }
  } else {
    host = document.createElement('div');
    host.style.all = 'initial'; // paranoia isolation
    document.body.appendChild(host);
  }
  const root = host.attachShadow({ mode: 'open' });

  // Bootstrap inside shadow (safe from host page)
  const bs = document.createElement('link');
  bs.rel = 'stylesheet';
  bs.href = 'https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css';
  root.appendChild(bs);

  // Optional Google font for title
  const fonts = document.createElement('link');
  fonts.rel = 'stylesheet';
  fonts.href = 'https://fonts.googleapis.com/css2?family=Calistoga&display=swap';
  root.appendChild(fonts);

  // -------------------------------
  // Styles (scoped)
  // -------------------------------
  const px = (v) => (typeof v === 'number' ? `${v}px` : v);

  const style = document.createElement('style');
  style.textContent = `
    :host { all: initial;
      --lavender-purple: #B993D6;
      --vibrant-orange: #f08000;
      --seafoam-green: #58B09C;
      --charcoal-purple: #49475B;
      --jet-black: #14080E;
    }

    /* Overlay (floating only) */
    #appertivo-overlay { 
      position: fixed; inset: 0;
      background: rgba(0,0,0,.3);
      opacity: 0; visibility: hidden;
      transition: all .25s ease;
    }
    #appertivo-overlay.show { opacity: 1; visibility: visible; }
    :host([data-inline]) #appertivo-overlay { display: none; }

    /* Modal container */
    #appertivo-widget-modal {
      background: #fff;
      border-radius: 20px;
      overflow: hidden;
      font-family: 'Segoe UI', Tahoma, sans-serif;
      box-shadow: 0 20px 60px rgba(0,0,0,0.15);
      transform: translateY(100px) scale(.8);
      opacity: 0;
      transition: all .35s cubic-bezier(.4,0,.2,1);
    }
    #appertivo-widget-modal.show { transform: translateY(0) scale(1); opacity: 1; }

    /* Floating placement */
    :host(:not([data-inline])) #appertivo-widget-modal {
      position: fixed;
      bottom: 120px; right: 30px;
      width: 380px; max-width: calc(100vw - 60px);
      z-index: 3;
    }

    /* Inline placement (hidden until .show to allow openOnLoad control) */
    :host([data-inline]) #appertivo-widget-modal {
      position: static;
      width: ${cfg.inlineWidth};
      max-width: ${cfg.inlineMaxWidth};
      margin: 0 auto;
      box-shadow: none;
      transform: none; /* avoid translate animation in inline */
    }
    :host([data-inline]) #appertivo-widget-modal:not(.show) { opacity: 0; }

    /* Launcher (floating only) */
    #appertivo-launcher {
      position: fixed;
      bottom: 30px; right: 30px;
      width: ${px(cfg.launcherSize)}; height: ${px(cfg.launcherSize)};
      background: ${cfg.launcherBg};
      border: 0;
      border-radius: ${cfg.launcherShape === 'pill' ? '999px' : '50%'};
      box-shadow: 0 8px 25px rgba(185,147,214,0.4);
      z-index: 2;
      display: flex; align-items: center; justify-content: center;
      font-size: 24px; color: ${cfg.launcherColor};
      cursor: pointer;
      animation: pulse 2s infinite;
      transition: transform .2s ease, box-shadow .2s ease;
      padding: 0 18px; /* works for pill shape text */
      line-height: 1;
      user-select: none;
    }
    #appertivo-launcher:hover { transform: scale(1.08) translateY(-2px); }

    @keyframes pulse {
      0% { box-shadow: 0 8px 25px rgba(185,147,214,0.4), 0 0 0 0 rgba(240,128,0,.6); }
      70%{ box-shadow: 0 8px 25px rgba(185,147,214,0.4), 0 0 0 12px rgba(240,128,0,0); }
      100%{box-shadow: 0 8px 25px rgba(185,147,214,0.4), 0 0 0 0 rgba(240,128,0,0); }
    }

    /* Card internals */
    .appertivo-special-image { width: 100%; height: 100%; max-height: 300px; object-fit: cover; opacity: .95; }

    .appertivo-widget-content { padding: 20px; }
    .appertivo-special-title { font-family: 'Calistoga', sans-serif; font-size: 20px; color: var(--jet-black); margin: 0 0 10px; }
    .appertivo-special-description { color: var(--charcoal-purple); font-size: 14px; line-height: 1.5; margin: 0 0 15px; }

    .appertivo-cta-buttons { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; margin-top: 16px; padding-top: 14px; border-top: 1px solid #f0f0f0; }
    .appertivo-cta-button { flex: 1; min-width: 120px; text-align: center; text-decoration: none; padding: 12px 14px; border-radius: 12px; font-weight: 700; font-size: 13px; color: #fff; }
    .appertivo-cta-button.order { background: linear-gradient(135deg, var(--vibrant-orange), #ff6b35); }
    .appertivo-cta-button.call { background: linear-gradient(135deg, var(--seafoam-green), #4a9b8e); }
    .appertivo-cta-button.mobile_order { background: linear-gradient(135deg, var(--lavender-purple), #9b7bc8); }

    /* Close button (SVG, no external deps) */
    .appertivo-close-btn {
      position: absolute; top: 12px; right: 12px;
      width: 36px; height: 36px; border-radius: 50%;
      border: 0; background: rgba(255,255,255,.95);
      display: flex; align-items: center; justify-content: center;
      color: var(--charcoal-purple);
      cursor: pointer;
    }
    .appertivo-close-btn svg { width: 20px; height: 20px; display: block; }

    /* Small screens */
    @media (max-width: 480px) {
      :host(:not([data-inline])) #appertivo-widget-modal { left: 15px; right: 15px; width: auto; }
      .appertivo-cta-buttons { flex-direction: column; }
      .appertivo-cta-button { flex: none; width: 100%; }
    }

    /* Toast */
    .appertivo-toast {
      position: fixed; bottom: 100px; right: 30px;
      background: rgba(20,8,14,.95); color: #fff;
      padding: 10px 14px; border-radius: 10px; font-size: 13px; z-index: 9999;
    }
  `;
  root.appendChild(style);

  if (cfg.inline) host.setAttribute('data-inline', '');

  // -------------------------------
  // DOM
  // -------------------------------
  const overlay = document.createElement('div');
  overlay.id = 'appertivo-overlay';
  root.appendChild(overlay);

  const modal = document.createElement('div');
  modal.id = 'appertivo-widget-modal';
  modal.innerHTML = `
    <div class="card shadow-sm mb-0">
      <div class="position-relative">
        <img src="" alt="Special Image" class="card-img-top appertivo-special-image">
        <button class="btn btn-light appertivo-close-btn" aria-label="Close">
          <!-- Inline SVG ensures icon always renders -->
          <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
            <path fill="currentColor" d="M18.3 5.71a1 1 0 0 0-1.41 0L12 10.59 7.11 5.7a1 1 0 1 0-1.41 1.42L10.59 12l-4.9 4.89a1 1 0 1 0 1.41 1.42L12 13.41l4.89 4.9a1 1 0 0 0 1.42-1.41L13.41 12l4.9-4.89a1 1 0 0 0-.01-1.4z"/>
          </svg>
        </button>
      </div>

      <div class="card-body appertivo-widget-content">
        <h5 class="card-title appertivo-special-title"></h5>
        <p class="card-text appertivo-special-description"></p>

        <form class="appertivo-signup-form" id="appertivo-email-form">
          <input type="email" id="appertivo-email-input" class="form-control form-control-sm mb-2 border-2" placeholder="Enter your email" maxlength="100" required>
          <button type="submit" class="btn btn-sm w-100 appertivo-submit-btn text-white" style="background:#f08000">Subscribe to Specials</button>
        </form>

        <div class="appertivo-cta-buttons mt-3 d-flex gap-2 flex-wrap justify-content-center"></div>
      </div>
    </div>
  `;
  root.appendChild(modal);

  // Launcher (floating only)
  let launcher = null;
  if (!cfg.inline) {
    launcher = document.createElement('button');
    launcher.id = 'appertivo-launcher';
    launcher.setAttribute('aria-label', cfg.launcherLabel || "View Today's Special");
    launcher.textContent = cfg.launcherIcon || 'ðŸ½ï¸'; // can be short text too
    root.appendChild(launcher);
  }

  // -------------------------------
  // Refs & helpers
  // -------------------------------
  const img = modal.querySelector('.appertivo-special-image');
  const title = modal.querySelector('.appertivo-special-title');
  const desc = modal.querySelector('.appertivo-special-description');
  const closeBtn = modal.querySelector('.appertivo-close-btn');
  const emailForm = modal.querySelector('#appertivo-email-form');
  const emailInput = modal.querySelector('#appertivo-email-input');
  const ctaContainer = modal.querySelector('.appertivo-cta-buttons');
  const signupFormWrap = emailForm;

  function showModal() {
    if (!cfg.inline) overlay.classList.add('show');
    modal.classList.add('show');
    // focus trap-ish
    closeBtn.focus({ preventScroll: true });
  }
  function hideModal() {
    if (!cfg.inline) overlay.classList.remove('show');
    modal.classList.remove('show');
  }
  function clearCTAs() { ctaContainer.innerHTML = ''; }

  function normalizeCtas(cta) {
    // Allow stringified JSON arrays defensively
    if (!cta) return [];
    let out = cta;
    if (typeof cta === 'string') {
      try { out = JSON.parse(cta); } catch { out = []; }
    }
    return Array.isArray(out) ? out : [];
  }

  function showToast(msg) {
    const t = document.createElement('div');
    t.className = 'appertivo-toast';
    t.textContent = msg;
    root.appendChild(t);
    setTimeout(() => t.remove(), 2400);
  }
function buildActionsFromPassthrough(sp) {
  const actions = [];
  if (sp.order_url)       actions.push({ type: 'order',        url: sp.order_url });
  if (sp.phone_number)    actions.push({ type: 'call',         phone: sp.phone_number });
  if (sp.mobile_order_url)actions.push({ type: 'mobile_order', url: sp.mobile_order_url });
  return actions;
}
function renderSpecial(special) {
  // Image, title, desc
  img.src = special.image_url || 'data:image/svg+xml;charset=utf-8,%3Csvg xmlns=%22http%3A//www.w3.org/2000/svg%22 width=%22600%22 height=%22300%22%3E%3Crect width=%22100%25%22 height=%22100%25%22 fill=%22%23B993D6%22/%3E%3C/svg%3E';
  img.alt = special.title || 'Special Image';
  title.textContent = special.title || "Today's Special";
  desc.textContent = special.description || '';

  // Subscribe on/off
  if (signupFormWrap) {
    const enabled = !!special.enable_email_signup;
    signupFormWrap.style.display = enabled ? '' : 'none';
  }

  // CTAs
  clearCTAs();

  // Prefer server-provided array if present, else build from passthrough
  let actions = [];
  if (Array.isArray(special.cta) && special.cta.length) {
    actions = special.cta;
  } else {
    actions = buildActionsFromPassthrough(special);
  }

  actions.forEach(action => {
    if (!action || !action.type) return;
    const btn = document.createElement('a');
    btn.className = 'appertivo-cta-button';
    btn.target = '_blank';
    btn.rel = 'noopener noreferrer';

    if (action.type === 'order' && (action.url || special.order_url)) {
      btn.href = action.url || special.order_url;
      btn.textContent = 'Order Now';
      btn.classList.add('order');
    } else if (action.type === 'call' && (action.phone || special.phone_number)) {
      btn.href = `tel:${action.phone || special.phone_number}`;
      btn.textContent = 'Call Now';
      btn.classList.add('call');
    } else if (action.type === 'mobile_order' && (action.url || special.mobile_order_url)) {
      btn.href = action.url || special.mobile_order_url;
      btn.textContent = 'Mobile Order';
      btn.classList.add('mobile_order');
    } else {
      return; // skip incomplete
    }

    ctaContainer.appendChild(btn);
  });
}

  // Hide the entire widget (used when no published specials)
  function hideWidgetCompletely() {
    if (!cfg.inline && launcher) launcher.remove();
    if (cfg.inline) {
      // Clear inline content
      root.innerHTML = '';
      // Keep an empty host so we don't error if called twice
    }
  }

  // Fetch logic with meta handling
  function fetchSpecial({ openAfter = false } = {}) {
    title.textContent = 'Loading...';
    desc.textContent = '';
    clearCTAs();

    let url = `${apiUrl}?restaurant=${encodeURIComponent(restaurantId)}`;
    if (specialId) {
      url += `&special=${encodeURIComponent(specialId)}`;
    }

    return fetch(url)
      .then(r => (r.ok ? r.json() : Promise.reject()))
      .then(data => {
        // If backend says the restaurant has no active specials, bail out and remove widget.
        const metaMode = data?.meta?.mode || '';
        const count = Number(data?.meta?.count ?? 0);

        if (metaMode === 'fallback_empty_restaurant' || count === 0 || !Array.isArray(data?.specials) || data.specials.length === 0) {
          hideWidgetCompletely();
          return null;
        }

        const sp = data.specials[0];
        if (!sp) {
          hideWidgetCompletely();
          return null;
        }

        renderSpecial(sp);
        if (openAfter) showModal();
        return sp;
      })
      .catch(() => {
        // If we canâ€™t load, quietly do nothing for floating (keeps FAB),
        // but avoid noisy UI. You could log here if needed.
        title.textContent = 'Unable to Load Specials';
        desc.textContent = 'Please try again later.';
        img.src = 'data:image/svg+xml;charset=utf-8,%3Csvg xmlns=%22http%3A//www.w3.org/2000/svg%22 width=%22600%22 height=%22300%22%3E%3Crect width=%22100%25%22 height=%22100%25%22 fill=%22%2358475B%22/%3E%3C/svg%3E';
        return null;
      });
  }

  // -------------------------------
  // Events
  // -------------------------------
  if (!cfg.inline && launcher) {
    launcher.addEventListener('click', () => {
      // Fetch latest, then open
      fetchSpecial({ openAfter: true });
    });
    overlay.addEventListener('click', hideModal);
    // Escape to close (floating only)
    root.addEventListener('keydown', (e) => { if (e.key === 'Escape') hideModal(); });
  }

  closeBtn.addEventListener('click', hideModal);

  emailForm.addEventListener('submit', (e) => {
    e.preventDefault();
    const email = emailInput.value.trim();
    if (!email) return;

    // x-www-form-urlencoded to reduce CORS preflight friction
    const body = new URLSearchParams({ email, restaurant_id: restaurantId });

    fetch(subscribeUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body
    })
    .then(() => {
      emailInput.value = '';
      showToast(`Thanks for subscribing, ${email}!`);
    })
    .catch(() => {
      showToast('Subscription failed. Please try again later.');
    });
  });

  // -------------------------------
  // Initial behavior
  // -------------------------------
  if (cfg.inline) {
    // Inline: fetch now; show immediately only if openOnLoad
    fetchSpecial().then(sp => {
      if (sp && cfg.openOnLoad) showModal();
      // If no specials, fetchSpecial() already removed the widget.
    });
  } else {
    // Floating: optional warm prefetch (silent). Keeps launcher hidden if no specials.
    if ('requestIdleCallback' in window) {
      requestIdleCallback(() => {
        fetchSpecial().then(sp => {
          if (!sp && launcher) launcher.remove(); // hide FAB when no specials
        });
      });
    } else {
      fetchSpecial().then(sp => {
        if (!sp && launcher) launcher.remove();
      });
    }
  }
})();
